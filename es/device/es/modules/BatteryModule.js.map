{"version":3,"file":"BatteryModule.js","sources":["../../../../../device/es/modules/BatteryModule.js"],"sourcesContent":["/*!\n * ***********************************\n * @ldesign/device v0.1.0          *\n * Built with rollup               *\n * Build time: 2024-10-21 14:32:55 *\n * Build mode: production          *\n * Minified: No                    *\n * ***********************************\n */\nimport { safeNavigatorAccess } from '../utils/index.js';\n\nclass BatteryModule {\n  constructor() {\n    this.name = \"battery\";\n    this.battery = null;\n    this.eventHandlers = /* @__PURE__ */ new Map();\n    this.customEventHandlers = /* @__PURE__ */ new Map();\n    this.batteryInfo = this.getDefaultBatteryInfo();\n  }\n  /**\n   * 初始化模块\n   */\n  async init() {\n    if (typeof window === \"undefined\") return;\n    try {\n      this.battery = await safeNavigatorAccess(async (nav) => {\n        if (\"getBattery\" in nav && nav.getBattery) {\n          return await nav.getBattery();\n        }\n        const navAny = nav;\n        return navAny.battery || navAny.mozBattery || navAny.webkitBattery;\n      }, null);\n      if (this.battery) {\n        this.updateBatteryInfo();\n        this.setupEventListeners();\n      }\n    } catch (error) {\n      console.warn(\"Battery API not supported or failed to initialize:\", error);\n    }\n  }\n  /**\n   * 销毁模块（优化：彻底清理所有引用）\n   */\n  async destroy() {\n    this.removeEventListeners();\n    this.battery = null;\n    this.eventHandlers.clear();\n    this.customEventHandlers.clear();\n  }\n  /**\n   * 获取电池信息\n   */\n  getData() {\n    this.updateBatteryInfo();\n    return {\n      ...this.batteryInfo\n    };\n  }\n  /**\n   * 获取电池电量（0-1）\n   */\n  getLevel() {\n    return this.batteryInfo.level;\n  }\n  /**\n   * 获取电池电量百分比（0-100）\n   */\n  getLevelPercentage() {\n    return Math.round(this.batteryInfo.level * 100);\n  }\n  /**\n   * 检查是否正在充电\n   */\n  isCharging() {\n    return this.batteryInfo.charging;\n  }\n  /**\n   * 获取充电时间（秒）\n   */\n  getChargingTime() {\n    return this.batteryInfo.chargingTime;\n  }\n  /**\n   * 获取放电时间（秒）\n   */\n  getDischargingTime() {\n    return this.batteryInfo.dischargingTime;\n  }\n  /**\n   * 获取充电时间（格式化）\n   */\n  getChargingTimeFormatted() {\n    return this.formatTime(this.batteryInfo.chargingTime);\n  }\n  /**\n   * 获取放电时间（格式化）\n   */\n  getDischargingTimeFormatted() {\n    return this.formatTime(this.batteryInfo.dischargingTime);\n  }\n  /**\n   * 检查电池是否电量低\n   */\n  isLowBattery(threshold = 0.2) {\n    return this.batteryInfo.level <= threshold;\n  }\n  /**\n   * 检查电池是否电量充足\n   */\n  isHighBattery(threshold = 0.8) {\n    return this.batteryInfo.level >= threshold;\n  }\n  /**\n   * 获取电池状态描述\n   */\n  getBatteryStatus() {\n    if (this.batteryInfo.charging) {\n      return \"charging\";\n    }\n    if (this.isLowBattery()) {\n      return \"low\";\n    }\n    if (this.isHighBattery()) {\n      return \"high\";\n    }\n    return \"normal\";\n  }\n  /**\n   * 获取默认电池信息\n   */\n  getDefaultBatteryInfo() {\n    return {\n      level: 1,\n      charging: false,\n      chargingTime: Number.POSITIVE_INFINITY,\n      dischargingTime: Number.POSITIVE_INFINITY\n    };\n  }\n  /**\n   * 更新电池信息\n   */\n  updateBatteryInfo() {\n    if (!this.battery) return;\n    const normalizeTime = (t) => {\n      if (typeof t !== \"number\" || !Number.isFinite(t) || t < 0 || t === Number.MAX_VALUE) return Number.POSITIVE_INFINITY;\n      return t;\n    };\n    this.batteryInfo = {\n      level: typeof this.battery.level === \"number\" ? this.battery.level : 1,\n      charging: !!this.battery.charging,\n      chargingTime: normalizeTime(this.battery.chargingTime),\n      dischargingTime: normalizeTime(this.battery.dischargingTime)\n    };\n    this.emit(\"batteryChange\", this.batteryInfo);\n  }\n  /**\n   * 格式化时间\n   */\n  formatTime(seconds) {\n    if (!Number.isFinite(seconds)) {\n      return \"\\u672A\\u77E5\";\n    }\n    const hours = Math.floor(seconds / 3600);\n    const minutes = Math.floor(seconds % 3600 / 60);\n    if (hours > 0) {\n      return `${hours}\\u5C0F\\u65F6${minutes}\\u5206\\u949F`;\n    }\n    return `${minutes}\\u5206\\u949F`;\n  }\n  /**\n   * 设置事件监听器\n   */\n  setupEventListeners() {\n    if (!this.battery || typeof this.battery.addEventListener !== \"function\") return;\n    const events = [\"chargingchange\", \"levelchange\", \"chargingtimechange\", \"dischargingtimechange\"];\n    events.forEach((event) => {\n      const handler = () => {\n        this.updateBatteryInfo();\n      };\n      this.eventHandlers.set(event, handler);\n      if (this.battery) {\n        this.battery.addEventListener(event, handler);\n      }\n    });\n  }\n  /**\n   * 移除事件监听器\n   */\n  removeEventListeners() {\n    if (!this.battery || typeof this.battery.removeEventListener !== \"function\") return;\n    this.eventHandlers.forEach((handler, event) => {\n      if (this.battery) {\n        this.battery.removeEventListener(event, handler);\n      }\n    });\n    this.eventHandlers.clear();\n  }\n  /**\n   * 添加自定义事件监听器\n   */\n  on(event, handler) {\n    if (!this.customEventHandlers.has(event)) {\n      this.customEventHandlers.set(event, /* @__PURE__ */ new Set());\n    }\n    this.customEventHandlers.get(event)?.add(handler);\n  }\n  /**\n   * 移除自定义事件监听器\n   */\n  off(event, handler) {\n    const handlers = this.customEventHandlers.get(event);\n    if (handlers) {\n      handlers.delete(handler);\n      if (handlers.size === 0) {\n        this.customEventHandlers.delete(event);\n      }\n    }\n  }\n  /**\n   * 触发自定义事件\n   */\n  emit(event, data) {\n    const handlers = this.customEventHandlers.get(event);\n    if (handlers) {\n      handlers.forEach((handler) => {\n        try {\n          handler(data);\n        } catch (error) {\n          console.warn(`Error in battery event handler for ${event}:`, error);\n        }\n      });\n    }\n  }\n}\n\nexport { BatteryModule };\n/*! End of @ldesign/device | Powered by @ldesign/builder */\n//# sourceMappingURL=BatteryModule.js.map\n"],"names":["BatteryModule","constructor","name","battery","eventHandlers","Map","customEventHandlers","batteryInfo","getDefaultBatteryInfo","init","window","safeNavigatorAccess","nav","getBattery","navAny","mozBattery","webkitBattery","updateBatteryInfo","setupEventListeners","error","console","warn","destroy","removeEventListeners","clear","getData","getLevel","level","getLevelPercentage","Math","round","isCharging","charging","getChargingTime","chargingTime","getDischargingTime","dischargingTime","getChargingTimeFormatted","formatTime","getDischargingTimeFormatted","isLowBattery","threshold","isHighBattery","getBatteryStatus","Number","POSITIVE_INFINITY","normalizeTime","t","isFinite","MAX_VALUE","emit","seconds","hours","floor","minutes","addEventListener","events","forEach","event","handler","set","removeEventListener","on","has","Set","get","add","off","handlers","delete","size","data"],"mappings":"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"}